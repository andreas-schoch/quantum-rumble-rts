(()=>{"use strict";var e,t={87:(e,t,r)=>{r.d(t,{u:()=>B});var i=r(260);const s="energy_storage_change",o="energy_production_change",n="energy_consumption_change",a="unit_selection_change",h=40,l=20,c=64,d=64;class u{constructor(e,t,r){this.energyPath={found:!1,distance:1/0,path:[]},this.isEnergyRoot=!1,this.findPathAsyncInProgress=!1,this.destroyed=!1,this.built=!1,this.sprite=null,this.healthCurrent=0,this.pendingBuild=[],this.pendingHealth=[],this.scene=e,this.id=Math.random().toString(36).substring(2,10),this.x=t*h+l,this.y=r*h+l,this.coordX=t,this.coordY=r,u.structuresById.set(this.id,this),this.buildCost=this.constructor.buildCost,this.CLASS=Object.getPrototypeOf(this).constructor}tick(e){if(!this.destroyed){if(!this.energyPath.found&&!this.isEnergyRoot&&!this.findPathAsyncInProgress)return this.findPathAsync();if(this.isEnergyRoot||this.energyPath.found)return!this.built&&0!==this.buildCost&&this.pendingBuild.length<this.buildCost?this.pendingBuild.push(this.scene.network.requestEnergy("build",1,this)):this.healthCurrent<this.CLASS.healthMax&&this.pendingHealth.length<this.CLASS.healthMax-this.healthCurrent?this.pendingHealth.push(this.scene.network.requestEnergy("health",1,this)):this.built||0!==this.buildCost||this.build(1),!0}}activate(){this.scene.network.world[this.coordY][this.coordX].ref=this,this.sprite&&this.sprite.clearTint(),u.activeStructureIds.add(this.id),u.structuresInUpdatePriorityOrder.push(this),u.structuresInUpdatePriorityOrder.sort(((e,t)=>t.CLASS.updatePriority-e.CLASS.updatePriority)),this.isEnergyRoot||(this.energyPath=this.scene.network.findPathToEnergySource(this)),this.healthCurrent=this.CLASS.healthMax}deactivate(){u.activeStructureIds.delete(this.id),u.structuresInUpdatePriorityOrder=u.structuresInUpdatePriorityOrder.filter((e=>e.id!==this.id)),this.CLASS.energyCollectionRange&&this.scene.network.stopCollecting(this)}hit(e){this.healthCurrent=Math.max(this.healthCurrent-e,0),0===this.healthCurrent&&this.destroy()}receiveEnergy(e){if(this.destroyed)throw new Error("This structure is already destroyed");if(!e)throw new Error("This structure does not have a pending energy request with that id");"build"===e.type?(this.build(e.amount),this.pendingBuild=this.pendingBuild.filter((t=>t.id!==e.id))):"health"===e.type&&(this.heal(e.amount),this.pendingHealth=this.pendingHealth.filter((t=>t.id!==e.id)))}findPathAsync(){this.findPathAsyncInProgress=!0,this.scene.network.findPathToEnergySourceAsync(this).then((e=>{this.energyPath=e,this.findPathAsyncInProgress=!1}))}destroy(){var e;null===(e=this.sprite)||void 0===e||e.destroy(),this.destroyed=!0,this.deactivate(),u.structuresById.delete(this.id),u.activeStructureIds.delete(this.id),this.scene.network.world[this.coordY][this.coordX].ref=null,this.CLASS.energyStorageCapacity&&(this.scene.network.energyStorageMax-=this.CLASS.energyStorageCapacity),this.CLASS.energyProduction&&(this.scene.network.energyProducing-=this.CLASS.energyProduction),this.CLASS.speedIncrease&&(this.scene.network.speed-=this.CLASS.speedIncrease)}heal(e){if(this.destroyed)throw new Error("This structure is already destroyed");this.healthCurrent=Math.min(this.healthCurrent+e,this.CLASS.healthMax)}build(e){var t;if(this.destroyed)throw new Error("This structure is already destroyed");if(this.built)throw new Error("This structure is already built");this.buildCost=Math.max(this.buildCost-e,0),this.buildCost<=0&&(this.CLASS.energyCollectionRange&&this.scene.network.startCollecting(this),this.healthCurrent=this.CLASS.healthMax,this.CLASS.energyProduction&&(this.scene.network.energyProducing+=this.CLASS.energyProduction),this.CLASS.energyStorageCapacity&&(this.scene.network.energyStorageMax+=this.CLASS.energyStorageCapacity),this.CLASS.speedIncrease&&(this.scene.network.speed+=this.CLASS.speedIncrease),null===(t=this.sprite)||void 0===t||t.setAlpha(1),this.built=!0)}draw(){}canMoveTo(e,t){return null===this.scene.network.world[t][e].ref||this.scene.network.world[t][e].ref===this}move(e,t){if(this.scene.network.world[t][e].ref===this)return;if(!this.CLASS.movable||this.destroyed)throw new Error("This structure is not movable or already destroyed");this.coordX=e,this.coordY=t,this.x=e*h+l,this.y=t*h+l,this.sprite&&this.sprite.setPosition(this.x,this.y);const r=this.scene.network.world[this.coordY][this.coordX],i=this.scene.network.world[t][e];return r.ref=null,i.ref=this,!0}}function p(e,t,r,i,s,o){let n=Math.PI/2*3,a=t,h=r;const l=Math.PI/i;e.beginPath(),e.moveTo(t,r-s);for(let c=0;c<i;c++)a=t+Math.cos(n)*s,h=r+Math.sin(n)*s,e.lineTo(a,h),n+=l,a=t+Math.cos(n)*o,h=r+Math.sin(n)*o,e.lineTo(a,h),n+=l;e.lineTo(t,r-s),e.closePath(),e.fillPath(),e.strokePath()}u.structuresInUpdatePriorityOrder=[],u.structuresById=new Map,u.activeStructureIds=new Set,u.energyCollectionRange=0,u.energyStorageCapacity=0,u.energyProduction=0,u.connectionRange=5,u.updatePriority=1,u.speedIncrease=0,u.isRelay=!1,u.movable=!1,u.type="structure";class g extends u{constructor(e,t,r){super(e,t,r),this.isEnergyRoot=!0,this.updatePriority=10,this.sprite=this.scene.add.sprite(this.x-60,this.y-60,g.unitName).setDepth(1e3).setOrigin(0,0),this.build(0)}static generateTextures(e){const t=e.add.graphics();t.fillStyle(11045156,1),t.lineStyle(2,0,1),p(t,60,60,8,58,48),t.fillStyle(14400599,1),p(t,60,60,8,40,36),t.generateTexture(g.unitName,120,120),t.destroy()}}function y(){return new Worker(r.p+"pathFinder.worker.4002a5a48d4f957bb460.bundle.worker.js")}g.unitName="City",g.buildCost=0,g.connectionRange=10,g.movable=!0,g.isRelay=!0,g.energyCollectionRange=4,g.energyProduction=20,g.energyStorageCapacity=100,g.healthMax=500;class f{constructor(){this.vertices=new Map,this.edges=new Map,this.edgesByVertex=new Map,this.heuristics={euclidian:this.heuristicEuclidian,manhattan:this.heuristicManhattan,chebyshev:this.heuristicChebyshev,octile:this.heuristicOctile}}createVertex(e,t,r,i){if(this.vertices.has(e))throw new Error(`Vertex with id ${e} already exists`);const s={id:e,data:i,x:t,y:r};return this.vertices.set(e,s),this.edgesByVertex.set(e,[]),s}removeVertex(e){if(!this.vertices.delete(e))return!1;const t=this.edgesByVertex.get(e);return this.edgesByVertex.delete(e),!t||(t.forEach((e=>this.edges.delete(e.id))),!0)}removeAllVertices(){let e=!0;return this.vertices.forEach((t=>{this.removeVertex(t.id)||(e=!1)})),e&&0===this.vertices.size&&0===this.edges.size}getNeighbourVertices(e){const t=this.edgesByVertex.get(e);if(!t)return[];const r=[];return t.forEach((t=>{const i=t.vertA===e?t.vertB:t.vertA,s=this.vertices.get(i);s&&r.push(s)})),r}createEdge(e,t,r,i){var s,o;const n={id:`${e}-${t}`,vertA:e,vertB:t,weight:r,data:i};return this.edges.set(n.id,n),null===(s=this.edgesByVertex.get(e))||void 0===s||s.push(n),null===(o=this.edgesByVertex.get(t))||void 0===o||o.push(n),n}getEdgeBetween(e,t){return this.edges.get(`${e}-${t}`)||this.edges.get(`${t}-${e}`)||null}removeEdgeBetween(e,t){var r,i;const s=this.getEdgeBetween(e,t);return s?(this.edges.delete(s.id),null===(r=this.edgesByVertex.get(e))||void 0===r||r.filter((e=>e.id!==s.id)),null===(i=this.edgesByVertex.get(t))||void 0===i||i.filter((e=>e.id!==s.id)),s):null}removeEdge(e){var t,r;const i=this.edges.get(e);return i?(this.edges.delete(e),null===(t=this.edgesByVertex.get(i.vertA))||void 0===t||t.filter((t=>t.id!==e)),null===(r=this.edgesByVertex.get(i.vertB))||void 0===r||r.filter((t=>t.id!==e)),i):null}findPath(e,t,r="euclidian",i=null){var s,o;const n=this.vertices.get(e),a=this.vertices.get(t);if(!a||!n)return{distance:1/0,path:[],found:!1};if(0===(null===(s=this.edgesByVertex.get(e))||void 0===s?void 0:s.length)||0===(null===(o=this.edgesByVertex.get(t))||void 0===o?void 0:o.length))return{distance:1/0,path:[],found:!1};const h=[],l=new Set,c=new Map,d=new Map;d.set(n,0),h.push({value:n,fScore:this.heuristics[r](n,a)});let u=!1;for(;h.length;){const e=h.pop().value;if(i&&i.fillCircle(e.x,e.y,20),e.id===t)break;u=!1;const s=this.edgesByVertex.get(e.id)||[];for(const t of s){const i=this.vertices.get(t.vertA===e.id?t.vertB:t.vertA),s=(d.get(e)||0)+t.weight;if(s<(d.get(i)||1/0)){if(c.set(i,e),d.set(i,s),!l.has(i)){const t=.275*(a.x-e.x+a.y-e.y);h.push({value:i,fScore:s+this.heuristics[r](i,a)+t}),u=!0}l.add(i)}}u&&h.sort(((e,t)=>t.fScore-e.fScore))}const p=[];let g=a;for(;g&&g.id!==e;){if(!c.get(g))return{distance:1/0,path:[],found:!1};p.push(g),g=c.get(g)}p.push(n),p.reverse();const y=d.get(a);return y?{distance:y,path:p,found:!0}:{distance:1/0,path:[],found:!1}}heuristicEuclidian(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}heuristicManhattan(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}heuristicChebyshev(e,t){return Math.max(Math.abs(e.x-t.x),Math.abs(e.y-t.y))}heuristicOctile(e,t){const r=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return Math.max(r,i)+.414*Math.min(r,i)}}var m=r(375);class S{constructor(e){this.world=[],this.graph=new f,this.textureKeysEdge=new Set,this.root=null,this.collectionMap=new Map,this.collectionSpriteSet=new Set,this.speed=150,this.energyProducing=0,this.energyCollecting=0,this.energyStorageMax=0,this.energyStorageCurrent=g.energyStorageCapacity,this.previewUnitClass=null,this.requestQueue=[],this.energyProducedPerSecond=0,this.energyConsumedPerSecond=0;for(let e=0;e<d;e++){const t=[];for(let r=0;r<c;r++)t.push({x:r,y:e,ref:null});this.world.push(t)}this.remoteGraph=(0,m.Ud)(new y),this.scene=e,this.previewEdgeSprite=this.scene.add.sprite(0,0,"cell_green").setDepth(499).setOrigin(0,.5),this.previewUnitSprite=this.scene.add.sprite(0,0,"cell_green").setDepth(499).setOrigin(0,.5),this.previewEdgeRenderTexture=this.scene.add.renderTexture(0,0,2560,2560).setDepth(499).setOrigin(0,0).setAlpha(.5),this.previewEdgeSprite.setVisible(!1),this.previewEdgeRenderTexture.draw(this.previewEdgeSprite)}tick(e){const t=this.energyProducing+this.energyCollecting,r=Math.min(this.energyStorageCurrent+.05*t,this.scene.network.energyStorageMax),i=this.scene.network.requestQueue.reduce(((e,t)=>e+t.amount),0);for(this.energyProducedPerSecond=t,this.energyStorageCurrent=r,this.energyDeficit=i;this.energyStorageCurrent>=1&&this.requestQueue.length;){const e=this.requestQueue.shift();this.energyStorageCurrent-=e.amount,this.energyConsumedPerSecond+=e.amount,this.sendEnergyBall(e)}this.scene.observer.emit(s,this.energyStorageCurrent,this.energyStorageMax),e%20==0&&(this.scene.observer.emit(o,this.energyProducedPerSecond),this.scene.observer.emit(n,this.energyConsumedPerSecond),this.energyConsumedPerSecond=0)}requestEnergy(e,t,r){if(r.destroyed)throw new Error("This structure is already destroyed");if(!r.energyPath.found)throw new Error("This structure is not connected to an energy source");const i={id:this.scene.network.generateId(),type:e,amount:t,requester:r};return this.requestQueue.push(i),i}generateId(){return Math.random().toString(36).substring(2,10)}getCellsInRange(e,t,r,i=!0){const s=[];for(let o=t-r;o<=t+r;o++)for(let n=e-r;n<=e+r;n++){if(n<0||o<0||n>=this.world[0].length||o>=this.world.length)continue;const a=this.world[o][n];if(i&&!a.ref)continue;const h=Math.abs(n-e)+Math.abs(o-t);h>r||s.push([a,h])}return s}sendEnergyBall(e){const t=e.requester.energyPath,r=t.path.reduce(((e,t)=>e.concat(t.x,t.y)),[]),i=this.scene.add.path(r[0],r[1]);for(let e=2;e<r.length;e+=2)i.lineTo(r[e],r[e+1]);const s="ammo"===e.type?"energy_red":"energy",o=t.distance/this.speed*1e3,n={follower:this.scene.add.follower(i,r[0],r[1],s),id:this.generateId()};n.follower.setScale(1).setDepth(501),n.follower.startFollow({duration:o,repeat:0,onComplete:()=>{n.follower.destroy(),e.requester.receiveEnergy(e)}})}startCollecting(e){const{coordX:t,coordY:r,CLASS:{energyCollectionRange:i}}=e;if(0!==i){this.scene.sfx_start_collect.play();for(let s=r-i;s<=r+i;s++)for(let n=t-i;n<=t+i;n++){if(n<0||s<0||n>=this.world[0].length||s>=this.world.length)continue;if(Math.abs(t-n)+Math.abs(r-s)>i)continue;const a=`${n}-${s}`,l=this.collectionMap.get(a)||[[],void 0];l[0].push(e),1===l[0].length&&(l[1]=this.scene.add.sprite(n*h,s*h,"cell_green").setDepth(500).setOrigin(0,0).setAlpha(.4),this.collectionSpriteSet.add(l[1])),this.collectionMap.set(a,l),this.energyCollecting=.005*this.collectionMap.size,this.scene.observer.emit(o,this.energyCollecting+this.energyProducing)}}}stopCollecting(e){var t;if(0===e.CLASS.energyCollectionRange||!u.activeStructureIds.has(e.id))return;const{coordX:r,coordY:i,CLASS:{energyCollectionRange:s}}=e;for(let n=i-s;n<=i+s;n++)for(let a=r-s;a<=r+s;a++){if(a<0||n<0||a>=this.world[0].length||n>=this.world.length)continue;if(Math.abs(r-a)+Math.abs(i-n)>s)continue;const h=`${a}-${n}`,l=this.collectionMap.get(h)||[[],void 0],c=l[0].findIndex((t=>t.id===e.id));-1!==c&&(l[0].splice(c,1),this.collectionMap.set(h,l),this.energyCollecting=.005*this.collectionMap.size,this.scene.observer.emit(o,this.energyCollecting+this.energyProducing),0===l[0].length&&l[1]&&(null===(t=l[1])||void 0===t||t.destroy(),this.collectionSpriteSet.delete(l[1])))}}previewStructure(e,t,r){null===e||null===t||e<0||t<0||e>=c||t>=d||r&&(this.previewUnitSprite.setPosition(e*h,t*h+l),this.previewUnitClass&&this.previewUnitClass!==r&&this.previewCancel(),this.previewUnitSprite.setTexture(r.unitName).setVisible(!0),this.previewUnitClass=r,this.previewEdge(e,t,r))}previewCancel(){this.previewEdgeRenderTexture.clear(),this.previewEdgeSprite.setVisible(!1),this.previewUnitSprite.setVisible(!1)}placeUnit(e,t,r){this.world[t][e].ref||(this.graph.createVertex(r.id,r.x,r.y,r),this.remoteGraph.createVertex(r.id,r.x,r.y,{x:r.x,y:r.y}),r instanceof g&&(this.root=r),this.connect(e,t,r),r.activate(),this.scene.sfx_place_structure.play())}previewEdge(e,t,r){this.previewEdgeRenderTexture.clear();for(const[i,s]of this.getCellsInRange(e,t,r.connectionRange)){if(!i.ref)continue;if(!i.ref.CLASS.isRelay&&!r.isRelay)continue;if(s>i.ref.CLASS.connectionRange)continue;this.previewEdgeSprite.setPosition(e*h+l,t*h+l);const o=Math.sqrt(Math.pow(this.previewEdgeSprite.x-i.ref.x,2)+Math.pow(this.previewEdgeSprite.y-i.ref.y,2));0!==Math.round(o)&&(this.previewEdgeSprite.setTexture(this.getEdgeSpriteTexture(o)),this.previewEdgeSprite.setRotation(Math.atan2(i.ref.y-this.previewEdgeSprite.y,i.ref.x-this.previewEdgeSprite.x)),this.previewEdgeRenderTexture.draw(this.previewEdgeSprite))}}connect(e,t,r){for(const[i,s]of this.getCellsInRange(e,t,r.CLASS.connectionRange)){if(!i.ref)continue;if(!i.ref.CLASS.isRelay&&!r.CLASS.isRelay)continue;if(i.ref.id===r.id)continue;const e=Math.sqrt(Math.pow(r.x-i.ref.x,2)+Math.pow(r.y-i.ref.y,2));if(s>i.ref.CLASS.connectionRange||0===Math.round(e))continue;const t=Math.atan2(i.ref.y-r.y,i.ref.x-r.x),o=this.scene.add.sprite(r.x,r.y,this.getEdgeSpriteTexture(e)).setDepth(499).setOrigin(0,.5).setRotation(t);this.graph.createEdge(r.id,i.ref.id,e,o),this.remoteGraph.createEdge(r.id,i.ref.id,e,"sprite placeholder")}}getEdgeSpriteTexture(e){const t=`line-${Math.round(e)}`;if(!this.textureKeysEdge.has(t)){const r=this.scene.add.graphics();r.fillStyle(0,1),r.fillRect(0,0,e,6),r.fillStyle(16777215,1),r.fillRect(0,2,e,2),r.generateTexture(t,e,6),r.destroy(),this.textureKeysEdge.add(t)}return t}removeStructure(e){var t;const r=this.graph.vertices.get(e);if(!r)return;null===(t=this.graph.edgesByVertex.get(e))||void 0===t||t.forEach((t=>{var r;const i=t.vertA===e?t.vertB:t.vertA;null===(r=this.graph.edgesByVertex.get(i))||void 0===r||r.filter((e=>e.id!==t.id)),t.data.destroy(),this.graph.edges.delete(t.id),this.remoteGraph.edges.then((e=>e.delete(t.id)))}));const i=this.world[r.data.coordY][r.data.coordX].ref;i&&(i.hit(i.CLASS.healthMax),this.world[r.data.coordY][r.data.coordX].ref=null),this.graph.removeVertex(e),this.remoteGraph.removeVertex(e)}findPathToEnergySource(e){if(!this.root)throw new Error("root is null");const t=this.root.id,r=e.id,i=this.graph.findPath(t,r,"euclidian");let s=!1;for(const t of i.path)if(t.data.id!==e.id&&!t.data.built){s=!0;break}return s?{path:[],distance:1/0,found:!1}:i}findPathToEnergySourceAsync(e){return t=this,r=void 0,s=function*(){if(!this.root)throw new Error("root is null");const t=this.root.id,r=e.id,i=yield this.remoteGraph.findPath(t,r,"euclidian");let s=!1;for(const t of i.path){if(t.id===e.id)continue;const r=u.structuresById.get(t.id);if(!r||!r.built){s=!0;break}}return s?{path:[],distance:1/0,found:!1}:i},new((i=void 0)||(i=Promise))((function(e,o){function n(e){try{h(s.next(e))}catch(e){o(e)}}function a(e){try{h(s.throw(e))}catch(e){o(e)}}function h(t){var r;t.done?e(t.value):(r=t.value,r instanceof i?r:new i((function(e){e(r)}))).then(n,a)}h((s=s.apply(t,r||[])).next())}));var t,r,i,s}}const x={squareSize:32};class C{constructor(e=x){this.polygonCache=new Map,this.ilerp=(e,t,r)=>(r-e)/(t-e)*this.config.squareSize,this.config=e}getSquareGeomData(e){const t=this.ilerp,r=this.config.squareSize,i=this.getShapeIndex(e),s=this.getHashKey(e,i),o=[],n=[];let a=[];switch(i){case 0:break;case 1:a=[{x:0,y:t(e.tl,e.bl,e.threshold)},{x:t(e.bl,e.br,e.threshold),y:r},{x:0,y:r}],o.push(a),n.push({p1:a[0],p2:a[1]});break;case 2:a=[{x:t(e.bl,e.br,e.threshold),y:r},{x:r,y:t(e.tr,e.br,e.threshold)},{x:r,y:r}],o.push(a),n.push({p1:a[0],p2:a[1]});break;case 3:a=[{x:0,y:t(e.tl,e.bl,e.threshold)},{x:r,y:t(e.tr,e.br,e.threshold)},{x:r,y:r},{x:0,y:r}],o.push(a),n.push({p1:a[0],p2:a[1]});break;case 4:a=[{x:r,y:t(e.tr,e.br,e.threshold)},{x:t(e.tl,e.tr,e.threshold),y:0},{x:r,y:0}],o.push(a),n.push({p1:a[0],p2:a[1]});break;case 5:a=[{x:0,y:t(e.tl,e.bl,e.threshold)},{x:t(e.bl,e.br,e.threshold),y:r},{x:0,y:r}],o.push(a),n.push({p1:a[0],p2:a[1]}),a=[{x:r,y:t(e.tr,e.br,e.threshold)},{x:t(e.tl,e.tr,e.threshold),y:0},{x:r,y:0}],o.push(a),n.push({p1:a[0],p2:a[1]});break;case 6:a=[{x:t(e.bl,e.br,e.threshold),y:r},{x:t(e.tl,e.tr,e.threshold),y:0},{x:r,y:0},{x:r,y:r}],o.push(a),n.push({p1:a[0],p2:a[1]});break;case 7:a=[{x:t(e.tl,e.tr,e.threshold),y:0},{x:0,y:t(e.tl,e.bl,e.threshold)},{x:0,y:r},{x:r,y:r},{x:r,y:0}],o.push(a),n.push({p1:a[0],p2:a[1]});break;case 8:a=[{x:t(e.tl,e.tr,e.threshold),y:0},{x:0,y:t(e.tl,e.bl,e.threshold)},{x:0,y:0}],o.push(a),n.push({p1:a[0],p2:a[1]});break;case 9:a=[{x:t(e.tl,e.tr,e.threshold),y:0},{x:t(e.bl,e.br,e.threshold),y:r},{x:0,y:r},{x:0,y:0}],o.push(a),n.push({p1:a[0],p2:a[1]});break;case 10:a=[{x:0,y:0},{x:t(e.tl,e.tr,e.threshold),y:0},{x:r,y:t(e.tr,e.br,e.threshold)},{x:r,y:r},{x:t(e.bl,e.br,e.threshold),y:r},{x:0,y:t(e.tl,e.bl,e.threshold)}],o.push(a),n.push({p1:a[1],p2:a[2]}),n.push({p1:a[4],p2:a[5]});break;case 11:a=[{x:0,y:0},{x:t(e.tl,e.tr,e.threshold),y:0},{x:r,y:t(e.tr,e.br,e.threshold)},{x:r,y:r},{x:0,y:r}],o.push(a),n.push({p1:a[1],p2:a[2]});break;case 12:a=[{x:0,y:0},{x:r,y:0},{x:r,y:t(e.tr,e.br,e.threshold)},{x:0,y:t(e.tl,e.bl,e.threshold)}],o.push(a),n.push({p1:a[2],p2:a[3]});break;case 13:a=[{x:0,y:0},{x:r,y:0},{x:r,y:t(e.tr,e.br,e.threshold)},{x:t(e.bl,e.br,e.threshold),y:r},{x:0,y:r}],o.push(a),n.push({p1:a[2],p2:a[3]});break;case 14:a=[{x:0,y:0},{x:r,y:0},{x:r,y:r},{x:t(e.bl,e.br,e.threshold),y:r},{x:0,y:t(e.tl,e.bl,e.threshold)}],o.push(a),n.push({p1:a[3],p2:a[4]});break;case 15:o.push([{x:0,y:0},{x:r,y:0},{x:this.config.squareSize,y:this.config.squareSize},{x:0,y:this.config.squareSize}]);break;default:throw new Error("Should never happen")}return{polygons:o,isoLines:n,shapeIndex:i,hash:s}}getHashKey(e,t){if(0===(t=t||this.getShapeIndex(e)))return"empty-square";if(15===t)return"full-square";const{tl:r,tr:i,br:s,bl:o}=C.floorDensityValues(e);return`${r}-${i}-${s}-${o}`}getShapeIndex(e){const{tl:t,tr:r,br:i,bl:s,threshold:o}=e;return(t>=o?8:0)+(r>=o?4:0)+(i>=o?2:0)+(s>=o?1:0)}static floorDensityValues(e){return e.tl=Math.floor(e.tl),e.tr=Math.floor(e.tr),e.br=Math.floor(e.br),e.bl=Math.floor(e.bl),e}}var w=r(48);class v{constructor(e){this.flowNeighbours=[[1,0],[-1,0],[0,1],[0,-1]],this.cellEdges=[[0,0],[1,0],[1,1],[0,1]],this.fluidChangeRequests=[],this.noise=(0,w.hA)(),this.config=e;const{elevationMax:t}=e.terrain,r=(e.terrain.worldSizeX+1)*(e.terrain.worldSizeY+1);this.prevFluid=new Uint16Array(r),this.fluid=new Uint16Array(r),this.terrain=new Uint16Array(r);for(let r=0;r<=e.terrain.worldSizeY;r++)for(let i=0;i<=e.terrain.worldSizeX;i++){const s=Math.max(this.noise(i/48,r/48)*t*2,0),o=this.noise(i/32,r/32)*t*2,n=this.noise(i/16,r/16)*t*1;let a=Math.min(Math.max((n+o+s)/3,0),t);a<2560&&(a=0);const h=r*(e.terrain.worldSizeX+1)+i;this.terrain[h]=a}}fluidChangeRequest(e,t,r,i=[[0,0]]){const s=r/(4*i.length);for(const[r,o]of i)for(const[i,n]of this.cellEdges)this.fluidChangeRequests.push({xCoord:e+r+i,yCoord:t+o+n,amount:s})}tick(e){const{flowRate:t,evaporation:r,overflow:i}=this.config.fluid,{worldSizeX:s,worldSizeY:o,elevationMax:n}=this.config.terrain,{terrain:a,fluid:h,prevFluid:l}=this;for(const{xCoord:e,yCoord:t,amount:r}of this.fluidChangeRequests){const o=t*(s+1)+e;h[o]=Math.max(Math.min(h[o]+r,n+i),0)}this.fluidChangeRequests.length=0,l.set(h);for(let e=0;e<=o;e++)for(let i=0;i<=s;i++){const n=e*(s+1)+i,c=l[n];if(c<1536&&(l[n]=Math.max(c-r,0)),c<1280)continue;const d=this.flowNeighbours.map((([t,r])=>{const h=i+t,c=e+r;if(!(h>=0&&h<=s&&c>=0&&c<=o))return[0,-1];const d=c*(s+1)+h;return[l[n]+1024*Math.floor(a[n]/1024)-(l[d]+1024*Math.floor(a[d]/1024)),d]})).sort(((e,t)=>t[0]-e[0]));for(const[e,r]of d){if(e<0||-1===r)continue;const i=Math.floor(Math.min(e*t,l[n]*t));i>=1&&(h[n]-=i,h[r]+=i)}}}}const b={terrain:{worldSizeX:c,worldSizeY:d,elevationMax:12288},fluid:{overflow:12288,flowRate:.15,evaporation:5},wallColor:9077372,terrainLayers:[{elevation:3072,depth:4,color:6641746},{elevation:6144,depth:7,color:7760227},{elevation:9216,depth:10,color:8878708},{elevation:12288,depth:13,color:9997189}],fluidLayerThresholds:[{elevation:1024,depth:1,color:4227511},{elevation:2048,depth:2,color:4227511},{elevation:3072,depth:3,color:4227511},{elevation:4096,depth:4,color:4227511},{elevation:5120,depth:5,color:4227511},{elevation:6144,depth:6,color:4227511},{elevation:7168,depth:7,color:4227511},{elevation:8192,depth:8,color:4227511},{elevation:9216,depth:9,color:4227511},{elevation:10240,depth:10,color:4227511},{elevation:11264,depth:11,color:4227511},{elevation:12288,depth:12,color:4227511},{elevation:13312,depth:13,color:4227511},{elevation:14336,depth:14,color:4227511},{elevation:15360,depth:15,color:4227511}]};class M{constructor(e,t=b){this.terrainGraphics=new Map,this.scene=e,this.config=t;const{fluid:r,terrain:i}=t;this.simulation=new v({terrain:i,fluid:r}),this.marchingSquares=new C({squareSize:h}),this.initTerrain(),t.fluidLayerThresholds.forEach((({elevation:e,depth:t,color:r})=>this.terrainGraphics.set(e,this.scene.add.graphics().setAlpha(1).setDepth(t).fillStyle(r,.4))))}tick(e){this.simulation.tick(e);const t=this.getVisibleBounds();if(t)for(const{elevation:e,color:r}of this.config.fluidLayerThresholds){const i=this.terrainGraphics.get(e);if(!i)throw new Error("no graphics");i.clear().fillStyle(r,.4);for(let r=t.coordY;r<=t.coordY+t.numCoordsY;r++)for(let s=t.coordX;s<=t.coordX+t.numCoordsX;s++)this.isWithinBounds(s,r)&&this.renderFluidAt(s,r,e,i)}}initTerrain(){var e,t,r;let i=this.scene.add.graphics().setDepth(1);i.fillStyle(5523265,1),i.fillRect(0,0,2560,2560);for(const{elevation:e,color:t,depth:r}of b.terrainLayers){i=this.scene.add.graphics().setDepth(r),i.lineStyle(2,0);for(let r=0;r<d;r++)for(let s=0;s<c;s++)i.fillStyle(9077372,1),this.renderTerrainAt(s,r,e,i,9,30),this.renderTerrainAt(s,r,e,i,6,20),this.renderTerrainAt(s,r,e,i,3,10),i.fillStyle(t,1),this.renderTerrainAt(s,r,e,i,0,0)}i=this.scene.add.graphics().setDepth((null===(e=this.config.terrainLayers.at(-1))||void 0===e?void 0:e.depth)||0),i.fillStyle(3355443,1),i.fillRect(0,2560,2560,h).setDepth((null===(t=this.config.terrainLayers.at(-1))||void 0===t?void 0:t.depth)||0),i.fillRect(2560,0,h,2600).setDepth((null===(r=this.config.terrainLayers.at(-1))||void 0===r?void 0:r.depth)||0)}getVisibleBounds(){const{x:e,y:t,width:r,height:i}=this.scene.cameras.main.worldView,s=e<0?Math.abs(e):0,o=r+e>2560?r+e-2560:0,n=Phaser.Math.Clamp(Math.floor((r-s-o)/h),0,63)+2;if(n<=0)return null;const a=t<0?Math.abs(t):0,l=i+t>2560?i+t-2560:0,c=Phaser.Math.Clamp(Math.floor((i-a-l)/h),0,63)+2;return c<=0?null:{coordX:Phaser.Math.Clamp(Math.floor(e/h)-1,0,63),coordY:Phaser.Math.Clamp(Math.floor(t/h)-1,0,63),numCoordsX:n,numCoordsY:c}}renderTerrainAt(e,t,r,i,s=0,o=0){const n=this.getCellEdges(e,t,r+3072);if(15===this.marchingSquares.getShapeIndex(n.terrain))return;const a=e*h+s,l=t*h+o,c=this.getCellEdges(e,t,r);this.renderAt(a,l,c.terrain,i)}renderFluidAt(e,t,r,i){const{terrain:s,fluid:o}=this.getCellEdges(e,t,r),n={tl:o.tl>=768?s.tl+o.tl:o.tl,tr:o.tr>=768?s.tr+o.tr:o.tr,br:o.br>=768?s.br+o.br:o.br,bl:o.bl>=768?s.bl+o.bl:o.bl,threshold:r},a=e*h,l=t*h;this.renderAt(a,l,n,i)}renderAt(e,t,r,i){const{polygons:s,isoLines:o,shapeIndex:n}=this.marchingSquares.getSquareGeomData(r);if(0!==n){if(i.translateCanvas(e,t),15===n)i.fillRect(0,0,h,h);else{for(const e of s)i.fillPoints(e,!0);for(const{p1:e,p2:t}of o)i.lineBetween(e.x,e.y,t.x,t.y)}i.translateCanvas(-e,-t)}}getCellEdges(e,t,r){const{worldSizeX:i}=this.config.terrain,s=t*(i+1)+e,o=s+i+1,n=s+1,a=o+1;return{terrain:{tl:this.simulation.terrain[s],tr:this.simulation.terrain[n],br:this.simulation.terrain[a],bl:this.simulation.terrain[o],threshold:r},fluid:{tl:this.simulation.fluid[s],tr:this.simulation.fluid[n],br:this.simulation.fluid[a],bl:this.simulation.fluid[o],threshold:r}}}isWithinBounds(e,t){return e>=0&&t>=0&&e<c&&t<d}}class P{constructor(e){this.emitters=[],this.onemit=()=>{},this.defaultEmitPattern=[[0,0]],this.scene=e}addEmitter(e){const t=Math.random().toString(36).substring(2,10);return this.emitters.push(Object.assign(Object.assign({},e),{id:t,active:!0,sprite:this.scene.add.sprite(e.xCoord*h+l,e.yCoord*h+l,"emitter").setOrigin(.5,.5).setDepth(1e4)})),t}removeEmitter(e){const t=this.emitters.findIndex((t=>t.id===e));return-1!==t&&this.emitters.splice(t,1),-1!==t}tick(e){for(const t of this.emitters)t.ticksDelay>e||t.ticksCooldown>1&&e%t.ticksCooldown!=1||this.onemit(t.xCoord,t.yCoord,.05*t.fluidPerSecond,this.defaultEmitPattern)}static generateTextures(e){const t=e.add.graphics();t.fillStyle(255,1),p(t,l,l,12,18,8),t.generateTexture("emitter",h,h),t.destroy()}}class k extends Phaser.Scene{constructor(){super({key:"GameScene"}),this.observer=new Phaser.Events.EventEmitter,this.pointerX=null,this.pointerY=null,this.pointerCoordX=null}create(){this.terrain=new M(this),this.sfx_start_collect=this.sound.add("start_collect",{detune:600,rate:1.25,volume:.5,loop:!1}),this.sfx_place_structure=this.sound.add("place_structure",{detune:200,rate:1.25,volume:1,loop:!1}),this.scene.launch("GameUIScene",[this,()=>{this.scene.restart()}]),this.setupCameraAndInput(),this.observer.removeAllListeners(),this.network=new S(this),this.city=new g(this,Math.floor(32),Math.floor(32)),this.network.placeUnit(this.city.coordX,this.city.coordY,this.city);const e=new P(this);e.addEmitter({xCoord:0,yCoord:0,fluidPerSecond:65536,ticksCooldown:1,ticksDelay:0}),e.addEmitter({xCoord:63,yCoord:0,fluidPerSecond:32768,ticksCooldown:1,ticksDelay:0}),e.addEmitter({xCoord:0,yCoord:63,fluidPerSecond:32768,ticksCooldown:1,ticksDelay:0}),e.addEmitter({xCoord:63,yCoord:63,fluidPerSecond:98304,ticksCooldown:1,ticksDelay:0}),e.onemit=(e,t,r,i)=>this.terrain.simulation.fluidChangeRequest(e,t,r,i),setTimeout((()=>{}),5e3),this.tickCounter=0,this.time.addEvent({delay:50,timeScale:1,callback:()=>{this.tickCounter++,e.tick(this.tickCounter),this.terrain.tick(this.tickCounter),this.network.tick(this.tickCounter);for(const e of u.structuresInUpdatePriorityOrder)e.tick(this.tickCounter)},callbackScope:this,loop:!0}),this.observer.on(a,(e=>this.selectUnit(e,!1)))}update(e,t){this.controls.update(t)}setupCameraAndInput(){const e=this.cameras.main,t=this.cameras.main.width/1920;e.setZoom(1*t),e.setBackgroundColor(3355443),e.centerOnX(1280),e.centerOnY(1280);let r=0,i=!1;const s=this.input.keyboard;if(!s)throw new Error("cursors is null");const o=s.addKey(Phaser.Input.Keyboard.KeyCodes.W),n=s.addKey(Phaser.Input.Keyboard.KeyCodes.A),a=s.addKey(Phaser.Input.Keyboard.KeyCodes.S),l=s.addKey(Phaser.Input.Keyboard.KeyCodes.D),u=s.addKey(Phaser.Input.Keyboard.KeyCodes.R),p=s.addKey(Phaser.Input.Keyboard.KeyCodes.ONE),g=s.addKey(Phaser.Input.Keyboard.KeyCodes.TWO),y=s.addKey(Phaser.Input.Keyboard.KeyCodes.THREE),f=s.addKey(Phaser.Input.Keyboard.KeyCodes.FOUR),m=s.addKey(Phaser.Input.Keyboard.KeyCodes.FIVE),S=s.addKey(Phaser.Input.Keyboard.KeyCodes.SIX),x=s.addKey(Phaser.Input.Keyboard.KeyCodes.SEVEN),C=s.addKey(Phaser.Input.Keyboard.KeyCodes.EIGHT),w=s.addKey(Phaser.Input.Keyboard.KeyCodes.NINE),v=s.addKey(Phaser.Input.Keyboard.KeyCodes.ESC),b=s.addKey(Phaser.Input.Keyboard.KeyCodes.X),M={0:[o,n,a,l],90:[l,o,n,a],180:[a,l,o,n],270:[n,a,l,o]};this.controls=new Phaser.Cameras.Controls.SmoothedKeyControl({camera:e,up:M[String(r)][0],left:M[String(r)][1],down:M[String(r)][2],right:M[String(r)][3],zoomIn:s.addKey(Phaser.Input.Keyboard.KeyCodes.Q),zoomOut:s.addKey(Phaser.Input.Keyboard.KeyCodes.E),acceleration:10,drag:.1,maxSpeed:.75,maxZoom:1.25,minZoom:.16666666666666666,zoomSpeed:.05}),u.onDown=t=>{i||t.ctrlKey||(i=!0,r+=90,r>=360&&(r=0),e.rotateTo(Phaser.Math.DegToRad(r),!1,350,"Linear",!1,((e,t)=>{1===t&&(i=!1)})),this.controls&&(this.controls.up=M[String(r)][0],this.controls.left=M[String(r)][1],this.controls.down=M[String(r)][2],this.controls.right=M[String(r)][3]))},p.onDown=()=>this.selectUnit(0),g.onDown=()=>this.selectUnit(1),y.onDown=()=>this.selectUnit(2),f.onDown=()=>this.selectUnit(3),m.onDown=()=>this.selectUnit(4),S.onDown=()=>this.selectUnit(5),x.onDown=()=>this.selectUnit(6),C.onDown=()=>this.selectUnit(7),w.onDown=()=>this.selectUnit(8),v.onDown=()=>this.selectUnit(-1),b.onDown=()=>this.selectUnit(-1);const P=this.input;P.mousePointer.motionFactor=.5,P.pointer1.motionFactor=.5,P.on("pointermove",(e=>{const{worldX:t,worldY:r}=e;this.pointerX=t,this.pointerY=r;const i=Math.floor(t/h),s=Math.floor(r/h);e.isDown||!this.selectedUnitClass||this.pointerCoordX===i&&this.pointerCoordY===s||(this.network.previewStructure(i,s,this.selectedUnitClass),this.pointerCoordX=i,this.pointerCoordY=s)})),P.on("pointerdown",(e=>{if(!this.selectedUnitClass)return;this.pointerCoordX=Math.floor(e.worldX/h),this.pointerCoordY=Math.floor(e.worldY/h);const{pointerCoordX:t,pointerCoordY:r}=this;if(null!==t&&null!==r&&!(t<0||r<0||t>c||r>d)&&this.selectedUnitClass){const e=new this.selectedUnitClass(this,t,r);this.network.placeUnit(t,r,e)}})),P.on("wheel",((t,r,i,s)=>{const o=e.zoom-(s>0?.025:-.025),n=Phaser.Math.Clamp(o,2/3,4/3);e.zoom=n}))}selectUnit(e,t=!0){const r=B[e]||null;this.network.previewCancel(),this.network.previewStructure(this.pointerCoordX,this.pointerCoordY,r),this.selectedUnitClass=r,t&&this.observer.emit(a,e)}}class E extends u{constructor(e,t,r){super(e,t,r),this.updatePriority=10,this.sprite=this.scene.add.sprite(this.x,this.y,E.unitName).setDepth(500).setAlpha(.3)}static generateTextures(e){const t=e.add.graphics();t.fillStyle(1605400,1),t.lineStyle(2,0,1),t.fillCircle(l,l,12),t.strokeCircle(l,l,12),t.fillStyle(7829367,1),t.fillCircle(l,l,6),t.strokeCircle(l,l,6),t.generateTexture(E.unitName,h,h),t.destroy()}}E.unitName="Storage",E.buildCost=20,E.isRelay=!1,E.movable=!1,E.connectionRange=5,E.energyCollectionRange=0,E.energyCollectionRate=0,E.energyProduction=0,E.energyStorageCapacity=20,E.healthMax=5;class T extends u{constructor(e,t,r){super(e,t,r),this.updatePriority=2,this.sprite=this.scene.add.sprite(this.x,this.y,T.unitName).setDepth(500).setAlpha(.3)}static generateTextures(e){const t=e.add.graphics();t.fillStyle(13882323,1),t.lineStyle(2,0,1),t.fillCircle(l,l,12),t.strokeCircle(l,l,12),t.fillStyle(16777215,1),t.fillCircle(l,l,6),t.strokeCircle(l,l,6),t.generateTexture(T.unitName,h,h),t.destroy()}}T.unitName="Collector",T.buildCost=5,T.isRelay=!0,T.movable=!1,T.connectionRange=5,T.energyCollectionRange=4,T.energyProduction=0,T.energyStorageCapacity=0,T.healthMax=1;class R extends u{constructor(e,t,r){super(e,t,r),this.updatePriority=1,this.sprite=this.scene.add.sprite(this.x,this.y,R.unitName).setDepth(5e3).setAlpha(.3)}static generateTextures(e){const t=e.add.graphics();t.fillStyle(13882323,1),t.lineStyle(2,0,1),p(t,l,23,3,16,8),t.fillStyle(16777215,1),p(t,l,23,3,8,4),t.generateTexture(R.unitName,h,h),t.destroy()}}R.unitName="Relay",R.buildCost=20,R.isRelay=!0,R.movable=!1,R.connectionRange=13,R.energyCollectionRange=0,R.energyCollectionRate=0,R.energyProduction=0,R.energyStorageCapacity=0,R.healthMax=1;class A extends u{constructor(e,t,r){super(e,t,r),this.updatePriority=10,this.sprite=this.scene.add.sprite(this.x,this.y,A.unitName).setDepth(500).setAlpha(.3)}static generateTextures(e){const t=e.add.graphics();t.fillStyle(3037570,1),t.lineStyle(2,0,1),p(t,l,l,4,18,8),t.generateTexture(A.unitName,h,h),t.destroy()}}A.unitName="Reactor",A.buildCost=40,A.connectionRange=5,A.energyCollectionRange=0,A.energyProduction=.3,A.energyStorageCapacity=0,A.healthMax=5;class I extends u{constructor(e,t,r){super(e,t,r),this.updatePriority=10,this.sprite=this.scene.add.sprite(this.x,this.y,I.unitName).setDepth(500).setAlpha(.3)}static generateTextures(e){const t=e.add.graphics();t.fillStyle(16711680,1),t.lineStyle(2,0,1),p(t,l,l,2,16,16),t.generateTexture(I.unitName,h,h),t.destroy()}}I.unitName="Speed",I.buildCost=35,I.isRelay=!1,I.movable=!1,I.connectionRange=5,I.energyCollectionRange=0,I.energyProduction=0,I.speedIncrease=20,I.energyStorageCapacity=0,I.healthMax=5;class K extends Phaser.Scene{constructor(){super({key:"PreloadScene"})}preload(){this.load.audio("place_structure",["assets/audio/sfx/place_structure/click.wav"]),this.load.audio("start_collect",["assets/audio/sfx/start_collect/sharp_echo.wav"]),this.load.audio("attack_turret",["assets/audio/sfx/attack_turret/footstep_concrete_001.ogg"]),this.load.audio("theme",["assets/audio/music/Kevin MacLeod/Shadowlands 4 - Breath.mp3"]),this.load.html("dom_game_ui","assets/html/game_ui.html")}create(){this.generateTextures(),this.scene.start("GameScene")}generateTextures(){g.generateTextures(this),T.generateTextures(this),R.generateTextures(this),E.generateTextures(this),A.generateTextures(this),I.generateTextures(this),P.generateTextures(this);const e=this.add.graphics();e.fillStyle(16777215,1),e.lineStyle(1,13421772,1),e.fillRect(0,0,h,h),e.strokeRect(0,0,h,h),e.generateTexture("cell_white",h,h),e.clear(),e.fillStyle(14876649,1),e.lineStyle(1,13421772,1),e.fillRect(0,0,h,h),e.strokeRect(0,0,h,h),e.generateTexture("cell_green",h,h),e.clear();const t=16;e.fillStyle(0,1),e.fillCircle(t,t,t),e.fillStyle(13882323,1),e.fillCircle(t,t,13),e.setScale(.5),e.generateTexture("energy",t,t),e.clear(),e.setScale(1),e.fillStyle(0,1),e.fillCircle(t,t,t),e.fillStyle(16711680,1),e.fillCircle(t,t,13),e.setScale(.5),e.generateTexture("energy_red",t,t),e.destroy()}}class L extends i.Scene{constructor(){super({key:"GameUIScene"})}init([e,t]){this.mainScene=e,this.observer=e.observer,this.restartGame=t,this.resolutionMod=this.game.canvas.width/1920}create(){this.initDomUi(),this.music=this.sound.add("theme",{loop:!0,volume:.4,rate:1,delay:0,detune:400}),this.music.play()}initDomUi(){const e=this.cameras.main.worldView.x+this.cameras.main.width/2,t=this.cameras.main.worldView.y+this.cameras.main.height/2,r=this.add.dom(e,t).createFromCache("dom_game_ui").setScale(this.resolutionMod);r.pointerEvents="none";const i=document.querySelector("#unit-selector"),h=document.getElementById("unit-template");B.forEach(((e,t)=>{const r=h.content.cloneNode(!0);r.querySelector(".unit-img").src=this.textures.getBase64(e.name)||this.textures.getBase64(T.name),r.querySelector(".unit").id=e.unitName,r.querySelector(".unit-name").innerHTML=e.unitName,r.querySelector(".unit-cost").innerHTML=String(e.buildCost),r.querySelector(".unit-hotkey").innerHTML=String(t+1),i.appendChild(r),i.querySelector("#"+e.unitName).onclick=()=>this.observer.emit(a,t)}));const l=i.querySelectorAll(".unit");this.observer.on(a,(e=>{-1!==e?l.forEach(((t,r)=>r===e?t.classList.add("selected"):t.classList.remove("selected"))):l.forEach((e=>e.classList.remove("selected")))}));const c=document.querySelector("#energy-storage-text"),d=document.querySelector("#energy-storage-progress");this.observer.on(s,((e,t)=>{c.innerText=`${e.toFixed(1)}/${t}`,d.style.width=e/t*100+"%"}));const u=document.querySelector("#energy-production");this.observer.on(o,(e=>u.innerText=`+ ${e.toFixed(2)}`));const p=document.querySelector("#energy-consumption");return this.observer.on(n,(e=>p.innerText=`- ${e.toFixed(2)}`)),r}}class q extends u{constructor(e,t,r){super(e,t,r),this.ammoCost=.25,this.updatePriority=1,this.ammoMax=10,this.ammoCurrent=0,this.attackRange=5,this.attackCooldown=5,this.damagePattern=[[0,0],[1,0],[-1,0],[0,1],[0,-1]],this.pendingAmmo=[],q.attackSFX||(q.attackSFX=e.sound.add("attack_turret",{detune:-200,rate:1.25,volume:.5,loop:!1})),this.graphics=e.add.graphics(),this.draw()}tick(e){if(super.tick(e))return this.built&&this.ammoCurrent<this.ammoMax&&this.pendingAmmo.length<this.ammoMax-this.ammoCurrent&&this.pendingAmmo.push(this.scene.network.requestEnergy("ammo",1,this)),this.attack(e),!0}move(e,t){super.move(e,t)&&this.draw()}receiveEnergy(e){super.receiveEnergy(e),"ammo"===e.type&&(this.ammoCurrent=Math.min(this.ammoCurrent+e.amount,this.ammoMax),this.pendingAmmo=this.pendingAmmo.filter((t=>t.id!==e.id)))}destroy(){super.destroy(),this.graphics.destroy()}attack(e){this.ammoCurrent<this.ammoCost||e-this.lastAttack<=this.attackCooldown||Math.random()>.6666||(this.ammoCurrent-=this.ammoCost,this.lastAttack=e,this.draw(),q.attackSFX.play(),this.scene.terrain.simulation.fluidChangeRequest(this.coordX,this.coordY,-q.damage,this.damagePattern))}getNearestTarget(){let e=null,t=1/0;for(let r=this.coordY-this.attackRange;r<=this.coordY+this.attackRange;r++)for(let i=this.coordX-this.attackRange;i<=this.coordX+this.attackRange;i++){if(i<0||r<0||i>=c||r>=d)continue;const s=this.scene.network.world[r][i];if(!s.ref)continue;const o=Math.abs(i-this.coordX)+Math.abs(r-this.coordY);o>this.attackRange||o<t&&(e=s,t=o)}return e}draw(){this.graphics.clear(),this.graphics.setPosition(this.x,this.y),this.graphics.setRotation(Phaser.Math.DegToRad(-45)),this.graphics.lineStyle(2,0,1),this.graphics.fillStyle(13882323,1),p(this.graphics,0,0,4,24,12),this.graphics.fillCircle(0,0,16),this.graphics.fillStyle(16711680,1);const e=this.ammoCurrent/this.ammoMax*360;this.graphics.slice(0,0,16,Phaser.Math.DegToRad(-45),Phaser.Math.DegToRad(-45+e)),this.graphics.fillPath(),this.graphics.strokeCircle(0,0,16),this.graphics.fillStyle(16777215,2),this.graphics.fillCircle(0,0,8),this.graphics.strokeCircle(0,0,8),this.graphics.setDepth(500)}}q.unitName="Weapon",q.buildCost=5,q.isRelay=!1,q.movable=!0,q.connectionRange=5,q.energyCollectionRange=0,q.energyProduction=0,q.energyStorageCapacity=0,q.healthMax=100,q.damage=8192;const D={type:i.WEBGL,backgroundColor:"0xffffff",scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH,width:960,height:540},dom:{createContainer:!0},disableContextMenu:!0,parent:"game",scene:[K,k,L]};window.addEventListener("load",(()=>{new i.Game(D),function(){const e=document.createElement("script");e.onload=function(){const e=new Stats;document.body.appendChild(e.dom),requestAnimationFrame((function t(){e.update(),requestAnimationFrame(t)}))},e.src="https://mrdoob.github.io/stats.js/build/stats.min.js",document.head.appendChild(e)}()}));const B=[T,R,q,q,q,q,E,I,A]}},r={};function i(e){var s=r[e];if(void 0!==s)return s.exports;var o=r[e]={exports:{}};return t[e].call(o.exports,o,o.exports,i),o.exports}i.m=t,e=[],i.O=(t,r,s,o)=>{if(!r){var n=1/0;for(c=0;c<e.length;c++){for(var[r,s,o]=e[c],a=!0,h=0;h<r.length;h++)(!1&o||n>=o)&&Object.keys(i.O).every((e=>i.O[e](r[h])))?r.splice(h--,1):(a=!1,o<n&&(n=o));if(a){e.splice(c--,1);var l=s();void 0!==l&&(t=l)}}return t}o=o||0;for(var c=e.length;c>0&&e[c-1][2]>o;c--)e[c]=e[c-1];e[c]=[r,s,o]},i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e;i.g.importScripts&&(e=i.g.location+"");var t=i.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var s=r.length-1;s>-1&&!e;)e=r[s--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=e})(),(()=>{var e={179:0};i.O.j=t=>0===e[t];var t=(t,r)=>{var s,o,[n,a,h]=r,l=0;if(n.some((t=>0!==e[t]))){for(s in a)i.o(a,s)&&(i.m[s]=a[s]);if(h)var c=h(i)}for(t&&t(r);l<n.length;l++)o=n[l],i.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return i.O(c)},r=self.webpackChunkquantum_rumble_rts=self.webpackChunkquantum_rumble_rts||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var s=i.O(void 0,[216],(()=>i(87)));s=i.O(s)})();